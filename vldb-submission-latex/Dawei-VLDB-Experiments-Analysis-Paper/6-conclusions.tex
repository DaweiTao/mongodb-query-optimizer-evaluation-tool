\section{Conclusions}
\label{sec:conclusions}

MongoDB uses a unique approach to query optimization, which we term \approachName query optimization. This  differs significantly from the traditional cost-based query optimization in that it chooses its execution plans based on an "execution race" with multiple candidate plans. To the best of our knowledge, this is the first paper explaining and evaluating this approach.

We analysed the effectiveness of MongoDB's \approachName optimizer using experiments that consider a set of queries, which adjust parameter values to vary the selectivity. For each query, we find which plan the MongoDB optimizer chooses, which plan is actually the fastest in execution, and we see how much worse the chosen plan is compared to the optimal one. Each of these aspects is displayed on a grid of cells. These displays provide two plan diagrams~\cite{reddy2005analyzing} and an innovative heatmap visualization of the impact on performance of the optimizer's choices.  This visualization makes it easy to visually identify areas where query planning can be improved.

We demonstrated that MongoDB 4.4.0 has a query plan preference bias: the current implementation of \approachName does not even consider a collection scan among the a candidate plans, unless it is requested to do so by the client, or there is no alternative. Furthermore, we showed that MongoDB calculation of plan productivity (during the race) underestimates the costs of an index scan where both index entry and document must be accessed. This leads MongoDB to choose an index-based plan that can be substantially slower than an optimal collection scan, for some queries that retrieve many of the documents. 

This paper offers the beginning of a deep study of the MongoDB query optimizer. So far we have only considered simple queries that run over a collection of documents with two atomic fields, and use range predicates on each field. In future work we will examine how the optimizer works on more complicated document schema, and more complicated queries. Our suggested adjustment of the productivity score to account for index access as well as document access, will also need to become more nuanced, before it would be appropriate for production use on a wider class of queries. Our approach could form the basis of an automated regression testing tool to verify that the query planner in MongoDB improves over time.


%We further proposed an improvement (by dynamically penalizing the productivity score of index scans) that lets MongoDB consider collection scans; but this change was still insufficient in all cases, so that we conclude that the preference bias closely relates to the underlying mechanism of query plan evaluation.

%Using our approach, we also quantified the impact of the preference bias issue. For the case in which both fields have an index, the accuracy of the query optimizer is only 69.29\%. Besides, the optimal query plan is up to 86.83\% faster than MongoDB's choice. We demonstrate that the overall performance of MongoDB's query optimizer can be improved by more than 10\% if MongoDB adopts the optimal query plans. In the single index scenario, the accuracy is even worse, which is 48.27\% . In the worst case, the optimal query plan is 253\% faster than MongoDB's choice. The overall performance can be improved is 31.58\% in this case. 

%We note that in reality the negative impact of the preference bias issue will be magnified since the larger scale of workload and more complex index structure result in a much higher overhead of the index scan. Furthermore, we repeat the experiment on datasets with different distributions; we observe that an advantage of \approachName is that it is insensitive to the skewness of the dataset.

% [UR: From Section 4 - better here?]
%We quantify the impact of the performance bias issue and present the results through a heatmap. Through experiments we determine the accuracy of the query optimizer is only 69.29\%. Besides that, the optimal query plan is up to 86.83\% faster than MongoDB's choice. We demonstrate that the overall performance of the MongoDB query optimizer can be improved by 10.96\% if MongoDB adopt the optimal query plans. We then examine various database designs by repeating the experiment on different dataset with various kinds of distribution to further explore the impact of this issue. We find that the distribution of the dataset does not  influence MongoDB's query plan decisions. 


%Last but not least, we identified the root cause of the preference bias issue through case studies. That is, the \approachName approach overrates the productivity of an index scan, and there is an unfair race between the collection scan and the index scan. In other words, the query optimizer underestimates the overhead of an index scan. As a result, index scans very likely outperform collection scans in all cases. We suggest MongoDB dynamically penalize the productivity sore of index scans to solve this issue.

